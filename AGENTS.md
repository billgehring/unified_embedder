# Repository Guidelines

## Project Structure & Module Organization
- Root-level Python modules power the pipeline: `unified_embedder.py` (entry point), `colbert_integration.py`, `hybrid_qdrant_store.py`, `reranking.py`, `query_expansion.py`, `deduplication.py`, `performance_*`.  
- Tests and utilities: `test_*.py`, `test_retrieval.sh`, `test_docs/`, `logs/`.  
- Data and refs: `reference_library_code/`, optional `qdrant_storage/`.  
- Key docs: `PROJECT_OVERVIEW.md`, `CLAUDE.md`, `README.md`.

## Build, Test, and Development Commands
- Setup deps (uv): `uv sync`  
- Install spaCy models: `uv run -m spacy download en_core_web_sm en_core_web_trf`  
- Start Qdrant (Docker): `./start_qdrant_docker.sh`  
- Run embedder (example):  
  `uv run unified_embedder.py --docs_dir ./sample_documents --qdrant --qdrant_collection sample --qdrant_url http://localhost:6333 --debug`  
- Tests (scripts):  
  `uv run test_gpu_setup.py` • `uv run test_qdrant_connectivity.py` • `uv run test_retrieval.py` • `./test_retrieval.sh <collection>`  
- Production helper: `bash run_embedder.sh`

## Coding Style & Naming Conventions
- Python 3.12. Follow PEP 8: 4-space indents, 88–100 col soft wrap.  
- Names: modules/files `snake_case.py`; functions/vars `lower_snake_case`; classes `CamelCase`; constants `UPPER_SNAKE`.  
- Type hints and docstrings for public functions. Keep modules focused; prefer small, composable functions.  
- Avoid committing generated artifacts (e.g., large `embeddings.json`, logs, caches).

## Testing Guidelines
- Tests are runnable Python scripts and a shell harness; no pytest is required.  
- Name new tests `test_<topic>.py` and place at repo root alongside other tests.  
- Keep tests hermetic where possible; mock network and filesystem when not needed.  
- Basic targets: GPU/MPS readiness, Qdrant connectivity, retrieval quality sanity.

## Commit & Pull Request Guidelines
- Commits: imperative and concise (e.g., "Add ColBERT MaxSim scoring"). Group related changes.  
- PRs: clear description, rationale, and scope; include run commands to reproduce, expected vs. actual results, and screenshots/log snippets when helpful.  
- Link related issues. Update docs when flags, defaults, or behaviors change.

## Security & Configuration Tips
- Secrets in `.env`; do not commit. Configuration is loaded via `python-dotenv`.  
- Validate Qdrant endpoints and collection names before running bulk jobs.  
- Large jobs: monitor with `logs/` output and `performance_*` tools.

## Architecture Notes
- Hybrid retrieval (dense+sparse) with optional reranking and ColBERT late interaction.  
- See `PROJECT_OVERVIEW.md` for diagrams, options, and end-to-end examples.

## Cross-Project Integration
- `shared-rag-service/` now consumes Qdrant collections generated by `unified_embedder/`.  
- Retrieval diagnostics mirror `unified_embedder/test_retrieval.py` via the service's `test_retrieval_service.py` and `test_retrieval.sh`.  
- Keep configuration (models, collection names, endpoints) synchronized across both repositories to ensure consistent tutoring responses.
